# Vercel KV 配置指南 - 批注多人同步功能

## 功能说明

批注系统已升级为支持多人协作同步：
- **实时同步**：通过智能轮询（5秒间隔）自动同步其他用户的批注
- **匿名协作**：用户输入昵称即可开始批注，无需登录
- **云端存储**：所有批注存储在 Vercel KV (Redis) 中，多设备可访问

## Vercel KV 配置步骤

### 1. 在 Vercel Dashboard 创建 KV 存储

1. 登录 [Vercel Dashboard](https://vercel.com/dashboard)
2. 选择你的项目 `smart-qa-v2-0`
3. 点击顶部的 **Storage** 标签
4. 点击 **Create Database**
5. 选择 **KV (Redis)**
6. 选择区域（建议选择与项目部署相同的区域）
7. 点击 **Create**

### 2. 连接到项目

创建 KV 存储后，Vercel 会自动将以下环境变量添加到你的项目：

- `KV_URL`
- `KV_REST_API_URL`
- `KV_REST_API_TOKEN`
- `KV_REST_API_READ_ONLY_TOKEN`

### 3. 重新部署

配置完成后，需要重新部署项目：

```bash
# 方法1：通过 Git 推送触发部署
git add .
git commit -m "feat: 添加批注多人同步功能 (Vercel KV)"
git push

# 方法2：通过 Vercel CLI 部署
vercel --prod
```

## 使用说明

### 添加批注
1. 点击顶部工具栏的 **添加批注** 按钮
2. 首次使用会要求输入昵称（存储在本地）
3. 点击任意内容区域添加批注
4. 输入批注内容后保存

### 同步状态指示器
- 🟢 **已同步** - 数据已与服务器同步
- 🔵 **同步中** - 正在获取最新数据
- 🟠 **离线** - 网络连接断开
- 🔴 **同步失败** - 同步出错，点击可重试

### 查看批注
- 点击 **批注列表** 按钮打开侧边栏查看所有批注
- 批注分为"待处理"和"已解决"两类
- 可以看到参与批注的用户数量

### 协作功能
- 所有用户的批注会自动同步（5秒轮询）
- 可以回复他人的批注进行讨论
- 任何人都可以标记批注为"已解决"
- 只有批注作者可以编辑或删除自己的批注

## API 端点

批注系统使用以下 API 端点：

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/annotations` | 获取所有批注 |
| POST | `/api/annotations` | 创建批注 |
| PUT | `/api/annotations?id=xxx` | 更新批注 |
| DELETE | `/api/annotations?id=xxx` | 删除批注 |
| POST | `/api/annotations?action=reply&id=xxx` | 添加回复 |
| POST | `/api/annotations?action=resolve&id=xxx` | 解决/重开批注 |

## 数据迁移

如果之前有本地保存的批注（localStorage），可以通过导出/导入功能迁移：

1. 打开旧版本页面
2. 点击 **导出批注** 下载 JSON 文件
3. 打开新版本页面
4. 点击 **导入批注** 上传 JSON 文件

## 故障排除

### 批注无法保存
- 检查 Vercel KV 是否已正确配置
- 确认环境变量已添加到项目
- 查看浏览器控制台是否有错误信息

### 同步状态一直显示"同步中"
- 检查网络连接
- 刷新页面重试
- 检查 Vercel Functions 日志

### 昵称无法保存
- 检查浏览器是否允许 localStorage
- 尝试清除浏览器缓存后重试

## 免费额度

Vercel KV 免费额度（Hobby 计划）：
- 30,000 请求/月
- 256 MB 存储
- 10,000 每日命令

对于 PRD 批注场景，这个额度通常足够使用。

## 技术架构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│     用户 A      │     │     用户 B      │     │     用户 C      │
│   (浏览器)      │     │   (浏览器)      │     │   (浏览器)      │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         │ 轮询/操作             │ 轮询/操作             │ 轮询/操作
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Vercel Serverless Functions                   │
│                     /api/annotations.js                          │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 │ @vercel/kv
                                 ▼
                    ┌─────────────────────────┐
                    │      Vercel KV          │
                    │    (Upstash Redis)      │
                    │                         │
                    │  Key: prd_annotations   │
                    │  Type: Hash             │
                    └─────────────────────────┘
```
