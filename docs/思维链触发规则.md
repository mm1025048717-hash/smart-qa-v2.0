# 思维链触发规则 - 开发文档

> 明确何时启用思维链组件，确保数字员工在合适的场景展示思考过程

---

## 📋 触发条件总览

### ✅ 必须启用思维链的场景

#### 1. 复杂数据分析任务（高优先级）

**触发关键词：**
- "分析"、"分析一下"、"帮我分析"
- "为什么"、"原因"、"找出原因"
- "对比"、"比较"、"差异"
- "趋势"、"预测"、"未来"
- "归因"、"拆解"、"下钻"

**示例问题：**
- "分析一下为什么11月销售额下降了"
- "对比各区域、各产品的销售表现"
- "找出导致业绩下滑的主要原因"
- "预测下个季度的销售趋势"
- "分析各渠道的转化率差异"

**思维链结构：**
```
理解问题 → 查询数据 → 分析对比 → 生成洞察 → 可视化展示
```

#### 2. 工具调用场景（高优先级）

**触发关键词：**
- "查询"、"获取"、"搜索"
- "调用"、"执行"、"运行"
- "从...获取"、"查找"

**示例问题：**
- "查询近3个月的销售数据"
- "获取最新的市场行情"
- "从知识库查找相关信息"
- "搜索最新的行业报告"

**思维链结构：**
```
知识库查询 → 工具调用 → 数据处理 → 结果返回
```

#### 3. 多步骤任务（高优先级）

**触发关键词：**
- "生成报告"、"制作报表"
- "清理数据"、"处理数据"
- "计算...并..."、"分析...然后..."

**示例问题：**
- "生成一份完整的销售分析报告"
- "清理并分析这批数据"
- "计算各产品的利润率并排序"
- "分析销售数据并生成可视化图表"

**思维链结构：**
```
任务拆解 → 步骤1 → 步骤2 → 步骤3 → 完成
```

#### 4. 归因分析（中优先级）

**触发关键词：**
- "为什么"、"原因"、"导致"
- "归因"、"根因"、"因素"

**示例问题：**
- "为什么11月销售额下降了"
- "导致业绩下滑的主要原因是什么"
- "归因分析一下各渠道的贡献"

**思维链结构：**
```
问题识别 → 数据查询 → 维度拆解 → 归因分析 → 结论输出
```

---

### ❌ 不需要思维链的场景

#### 1. 简单问答
- "你好"、"你是谁"、"介绍一下自己"
- "今天天气怎么样"（非数据问题）
- 简单的问候和闲聊

#### 2. 单一数据查询
- "今年销售额是多少"
- "本月订单量有多少"
- "日活数据是多少"

**注意：** 如果只是查询单个数值，不需要思维链。但如果查询后还需要分析、对比、可视化，则需要思维链。

#### 3. 知识问答
- "什么是ROI"
- "如何计算毛利率"
- "数据仓库和数据库的区别"

---

## 🎯 复杂度判断标准

### 判断流程

```
用户问题
  ↓
是否需要2步以上操作？
  ├─ 是 → 使用思维链
  └─ 否 → 继续判断
      ↓
涉及多个数据源或工具？
  ├─ 是 → 使用思维链
  └─ 否 → 继续判断
      ↓
需要推理、分析、归因？
  ├─ 是 → 使用思维链
  └─ 否 → 不使用思维链
```

### 判断规则表

| 问题类型 | 步骤数 | 数据源数 | 需要推理 | 是否使用思维链 |
|---------|--------|---------|---------|---------------|
| 简单查询 | 1 | 1 | 否 | ❌ 否 |
| 多数据源查询 | 1 | 2+ | 否 | ✅ 是 |
| 单步分析 | 1 | 1 | 是 | ✅ 是 |
| 多步分析 | 2+ | 1+ | 是 | ✅ 是 |
| 工具调用 | 1+ | 1+ | 可能 | ✅ 是 |
| 报告生成 | 3+ | 1+ | 是 | ✅ 是 |

---

## 📊 思维链状态管理

### 状态流转

```
pending (初始) 
  ↓
loading (执行中) + blink: true
  ↓
success (成功) 或 error (失败) 或 abort (中止)
```

### 状态使用规则

1. **loading + blink: true**
   - 当前正在执行的步骤
   - 只有一个步骤可以是 loading
   - 必须设置 `blink: true` 突出显示

2. **success**
   - 已成功完成的步骤
   - 所有历史步骤都应该是 success

3. **error**
   - 执行失败的步骤
   - 必须在 `content` 中说明错误原因
   - 后续步骤可以继续执行或中止

4. **abort**
   - 被用户或系统中止的步骤
   - 通常发生在用户停止输出时

---

## 💻 代码实现

### 在 Prompt 中的规则

已在 `src/services/deepseekApi.ts` 的 `INTERACTIVE_GUIDE` 中添加了思维链触发规则。

### 自动检测（可选扩展）

可以添加一个函数自动检测问题复杂度：

```typescript
// src/services/thoughtChainDetector.ts
export function shouldUseThoughtChain(query: string): boolean {
  // 复杂分析关键词
  const analysisKeywords = ['分析', '为什么', '原因', '对比', '比较', '归因', '找出', '预测', '趋势'];
  
  // 工具调用关键词
  const toolKeywords = ['查询', '获取', '搜索', '调用', '执行', '从...获取', '查找'];
  
  // 多步骤关键词
  const multiStepKeywords = ['生成报告', '制作报表', '清理数据', '处理数据', '计算...并'];
  
  // 检查是否包含关键词
  const hasAnalysis = analysisKeywords.some(kw => query.includes(kw));
  const hasTool = toolKeywords.some(kw => query.includes(kw));
  const hasMultiStep = multiStepKeywords.some(kw => query.includes(kw));
  
  // 检查问题长度（长问题通常更复杂）
  const isLongQuery = query.length > 20;
  
  // 检查是否包含多个动词（多步骤任务）
  const verbCount = (query.match(/[查询|分析|计算|生成|获取|对比|找出]/g) || []).length;
  const hasMultipleVerbs = verbCount >= 2;
  
  return hasAnalysis || hasTool || hasMultiStep || (isLongQuery && hasMultipleVerbs);
}
```

### 在 App.tsx 中使用（可选）

```typescript
// 在 handleSend 中
const shouldShowThoughtChain = shouldUseThoughtChain(query);

if (shouldShowThoughtChain) {
  // 可以在 prompt 中强调使用思维链
  // 或者在 UI 中提示用户"正在分析中..."
}
```

---

## 🎨 UI 展示建议

### 思维链位置

1. **回答开头**：思维链应该放在回答的最开始
2. **实时更新**：在流式输出过程中，逐步更新思维链状态
3. **视觉突出**：当前执行的步骤（loading + blink）应该明显突出

### 用户体验

1. **渐进式展示**：思维链逐步展开，让用户看到思考过程
2. **可折叠**：复杂任务的思维链支持折叠，避免占用太多空间
3. **状态反馈**：清晰的状态图标（loading、success、error）让用户了解进度

---

## 📝 示例

### 示例1：复杂分析问题

**用户问题：** "分析一下为什么11月销售额下降了，并对比各区域的差异"

**思维链：**
```json
[thought-chain:{
  "items": [
    {
      "key": "understand",
      "title": "理解问题",
      "description": "分析用户意图：需要找出销售额下降原因并对比区域差异",
      "status": "success"
    },
    {
      "key": "query-data",
      "title": "查询数据",
      "description": "获取11月及对比月份的销售数据",
      "status": "loading",
      "blink": true,
      "collapsible": true,
      "content": "查询SQL：SELECT region, date, SUM(amount) FROM sales WHERE date BETWEEN '2024-10-01' AND '2024-11-30' GROUP BY region, date"
    },
    {
      "key": "compare",
      "title": "对比分析",
      "description": "对比10月和11月各区域的数据差异",
      "status": "success"
    },
    {
      "key": "attribution",
      "title": "归因分析",
      "description": "分析导致下降的主要因素",
      "status": "success"
    },
    {
      "key": "visualize",
      "title": "生成可视化",
      "description": "创建图表展示分析结果",
      "status": "success"
    }
  ]
}]
```

### 示例2：工具调用

**用户问题：** "帮我查询最新的市场行情并分析对我们业务的影响"

**思维链：**
```json
[thought-chain:{
  "items": [
    {
      "key": "knowledge-query",
      "title": "知识库查询",
      "description": "查询知识库获取相关信息",
      "status": "success"
    },
    {
      "key": "web-search",
      "title": "网页搜索工具调用",
      "description": "搜索最新的市场行情数据",
      "status": "loading",
      "blink": true,
      "collapsible": true,
      "content": "正在搜索：最新的市场行情数据..."
    },
    {
      "key": "analyze-impact",
      "title": "分析业务影响",
      "description": "分析市场行情对业务的影响",
      "status": "success"
    },
    {
      "key": "generate-insights",
      "title": "生成洞察建议",
      "description": "基于分析结果提供建议",
      "status": "success"
    }
  ]
}]
```

---

## 🔧 调试和优化

### 常见问题

1. **思维链没有显示**
   - 检查 prompt 中是否包含思维链规则
   - 检查问题是否满足触发条件
   - 检查 AI 是否理解规则

2. **状态更新不及时**
   - 确保在流式输出中实时更新状态
   - 检查 JSON 格式是否正确

3. **过度使用思维链**
   - 简单问题不应该使用思维链
   - 根据判断规则过滤

### 优化建议

1. **逐步启用**：先在高复杂度场景启用，再逐步扩展到中等复杂度
2. **用户反馈**：收集用户反馈，调整触发规则
3. **性能考虑**：思维链会增加 token 消耗，需要平衡用户体验和成本

---

**最后更新**：2024-12-12












