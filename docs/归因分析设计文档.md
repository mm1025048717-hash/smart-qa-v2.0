# 归因分析功能设计文档

> 版本：v1.0  
> 更新日期：2024-12-19  
> 作者：Smart QA Team

---

## 一、设计背景与目标

### 1.1 问题背景

在数据分析场景中，用户经常需要了解指标变化的原因。传统的做法是：
1. 用户看到数据下降/上升
2. 手动点击"归因"按钮
3. 系统展示归因分析结果

但这存在一个**设计矛盾**：
- 当用户**直接问**"为什么销售额下降了？"时，问题本身就是在请求归因
- 此时如果回复中还显示"归因"按钮，就是**重复**了

### 1.2 设计目标

建立一套**智能归因展示系统**，能够：
1. 区分"查数据"和"问原因"两种意图
2. 避免重复展示归因入口
3. 提供流畅的归因分析体验

---

## 二、核心设计原则

### 2.1 场景分类

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户提问                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │   查数据意图     │             │   问原因意图     │
    │ (Data Query)    │             │ (Attribution)   │
    └─────────────────┘             └─────────────────┘
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │ "今年销售额？"   │             │ "为什么下降？"   │
    │ "本月订单量？"   │             │ "增长原因？"     │
    │ "各地区对比？"   │             │ "影响因素？"     │
    └─────────────────┘             └─────────────────┘
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │  展示数据        │             │  展示归因分析    │
    │  + 归因按钮 ✅   │             │  无归因按钮 ❌   │
    └─────────────────┘             └─────────────────┘
```

### 2.2 设计规则表

| 场景类型 | 用户问题示例 | 主内容区 | 归因按钮 | 归因面板 |
|---------|------------|---------|---------|---------|
| **查数据** | "今年销售额是多少？" | 数据+KPI | ✅ 显示 | 点击后弹出 |
| **直接问归因** | "为什么销售额下降了？" | 完整归因分析 | ❌ 隐藏 | 不自动弹出 |
| **查数据后追问** | 看到下降 → 点击"归因" | - | - | ✅ 弹出面板 |

---

## 三、原型图设计

### 3.1 场景A：查数据（显示归因入口）

**用户输入：** "今年销售额是多少？"

```
┌─────────────────────────────────────────────────────────────────┐
│  📊 查询结果                                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  2024年度销售额                    ↑ 19.8% 同比增长 [归因] │   │
│  │                                                         │   │
│  │  ¥3,856 万元                                            │   │
│  │                                                         │   │
│  │  ┌────────┬────────┬────────┬────────┐                 │   │
│  │  │  Q1    │  Q2    │  Q3    │  Q4    │                 │   │
│  │  │ 823万  │ 945万  │ 1028万 │ 1060万 │                 │   │
│  │  └────────┴────────┴────────┴────────┘                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  2024年度销售额表现优异，实现¥3856万元，同比增长19.8%。           │
│  Q4达到年度峰值¥1060万元，全年呈稳步上升趋势。                    │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  📈 年度趋势对比（2024 vs 2023）                         │   │
│  │  ▲                                                      │   │
│  │  │    ╭─────────────────────────╮ ← 2024年              │   │
│  │  │   ╱                           ╲                      │   │
│  │  │  ╱  ╭─────────────────────────╮ ← 2023年             │   │
│  │  │ ╱  ╱                                                 │   │
│  │  └──────────────────────────────────────▶               │   │
│  │    1月  3月  5月  7月  9月  11月                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐                  │
│  │ 查看地区分布 │ │ 分析渠道构成 │ │ 预测下月趋势 │                  │
│  └────────────┘ └────────────┘ └────────────┘                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

                              │
                              │ 用户点击 [归因] 按钮
                              ▼

┌─────────────────────────────────────────────────────────────────┐
│  📊 查询结果                              ┌─────────────────────┤
│                                          │  🔍 归因分析         │
│  ┌────────────────────────────────────┐  │  12月 环比下降2.8%  │
│  │  2024年度销售额      ↑ 19.8% [归因] │  ├─────────────────────┤
│  │  ¥3,856 万元                       │  │                     │
│  └────────────────────────────────────┘  │  整体环比下降2.8%，  │
│                                          │  主要受华东区门店    │
│  ...                                     │  关闭和线上流量下滑  │
│                                          │  影响。              │
│                                          │                     │
│                                          │  影响因素 (4个)      │
│                                          │  ┌─────────────────┐│
│                                          │  │ 📍 华东区  -8万 ││
│                                          │  │ ████████░░ 45%  ││
│                                          │  ├─────────────────┤│
│                                          │  │ 📱 线上渠道 -5万 ││
│                                          │  │ █████░░░░░ 30%  ││
│                                          │  ├─────────────────┤│
│                                          │  │ 📦 产品A  -3万  ││
│                                          │  │ ███░░░░░░░ 15%  ││
│                                          │  ├─────────────────┤│
│                                          │  │ ⚙️ 其他   -2万  ││
│                                          │  │ ██░░░░░░░░ 10%  ││
│                                          │  └─────────────────┘│
│                                          │                     │
│                                          │  [查看华东详情]      │
│                                          └─────────────────────┤
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 场景B：直接问归因（无归因按钮）

**用户输入：** "为什么销售额下降了？"

```
┌─────────────────────────────────────────────────────────────────┐
│  🔍 销售额下降原因归因分析                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  本月销售额                         ↓ 12.5% 环比下降     │   │
│  │                                     ⚠️ 注意：无[归因]按钮 │   │
│  │  ¥320 万                                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  销售额环比下降 **12.5%**（约46万），以下是归因分析结果：          │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  📊 下降原因归因占比                                      │   │
│  │                                                         │   │
│  │              ┌────────────────┐                         │   │
│  │         ╱────│  促销活动减少   │ 35%                     │   │
│  │       ╱      │    35%         │                         │   │
│  │      │       └────────────────┘                         │   │
│  │      │    ╲  ┌────────────────┐                         │   │
│  │      │      ╲│  华东区异常    │ 28%                      │   │
│  │      │       │    28%         │                         │   │
│  │       ╲      └────────────────┘                         │   │
│  │        ╲     ┌────────────────┐                         │   │
│  │         ╲────│  线上流量下滑   │ 22%                     │   │
│  │              └────────────────┘                         │   │
│  │              ┌────────────────┐                         │   │
│  │              │  新品延迟上市   │ 15%                     │   │
│  │              └────────────────┘                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  📉 各因素影响金额（万元）                                │   │
│  │                                                         │   │
│  │  促销活动减少  ████████████████████████████  -16.1万     │   │
│  │  华东区异常    ██████████████████████        -12.9万     │   │
│  │  线上流量下滑  ████████████████              -10.1万     │   │
│  │  新品延迟上市  ██████████                    -6.9万      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  💡 归因结论                                             │   │
│  │  促销活动减少是主要原因（35%），建议下月增加2-3场促销活动。   │
│  │  华东区需专项排查。                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌────────────────┐ ┌────────────────┐                         │
│  │ 华东区详情      │ │ 优化促销策略    │                         │
│  └────────────────┘ └────────────────┘                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 场景对比图

```
┌─────────────────────────────────────────────────────────────────┐
│                        场景对比                                  │
├────────────────────────────┬────────────────────────────────────┤
│      查数据场景             │       直接问归因场景               │
├────────────────────────────┼────────────────────────────────────┤
│                            │                                    │
│  "今年销售额是多少？"       │  "为什么销售额下降了？"             │
│                            │                                    │
│  ┌────────────────────┐    │  ┌────────────────────┐           │
│  │ 销售额              │    │  │ 销售额下降归因分析  │           │
│  │ ¥3,856万           │    │  │ ¥320万            │           │
│  │ ↑19.8% [归因]  ←───┼────┼──│ ↓12.5%            │           │
│  └────────────────────┘    │  └────────────────────┘           │
│        │                   │           │                       │
│        │ 有归因按钮         │           │ 无归因按钮             │
│        │                   │           │                       │
│        ▼                   │           ▼                       │
│  ┌────────────────────┐    │  ┌────────────────────┐           │
│  │ 📈 趋势图           │    │  │ 🥧 归因饼图         │           │
│  │ 数据展示为主        │    │  │ 原因分析为主        │           │
│  └────────────────────┘    │  └────────────────────┘           │
│                            │                                    │
│  用户想看数据              │  用户想知道原因                     │
│  → 提供数据 + 归因入口     │  → 直接给出原因分析                 │
│                            │                                    │
└────────────────────────────┴────────────────────────────────────┘
```

---

## 四、归因面板设计

### 4.1 面板结构

```
┌─────────────────────────────────────────┐
│  🔍 归因分析                        ✕   │
│  12月 环比下降2.8%                      │
├─────────────────────────────────────────┤
│                                         │
│  整体环比下降2.8%，主要受华东区门店关闭   │
│  和线上渠道流量下滑影响。                │
│                                         │
├─────────────────────────────────────────┤
│  影响因素 (4个)                         │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 📍 华东区                -80,000 │   │
│  │ ████████████████████░░░░  45.0% │   │
│  │                          [下钻>] │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 📱 线上渠道              -50,000 │   │
│  │ ████████████░░░░░░░░░░░  30.0% │   │
│  │                          [下钻>] │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 📦 产品A                 -30,000 │   │
│  │ ███████░░░░░░░░░░░░░░░░  15.0% │   │
│  │                          [下钻>] │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ ⚙️ 其他因素              -20,000 │   │
│  │ ████░░░░░░░░░░░░░░░░░░░  10.0% │   │
│  └─────────────────────────────────┘   │
│                                         │
├─────────────────────────────────────────┤
│  📝 归因总结                            │
│                                         │
│  主要影响因素：华东区（45%）             │
│  根本原因：门店装修停业导致线下流量减少   │
│  建议措施：加大线上投放弥补线下缺口       │
│                                         │
└─────────────────────────────────────────┘
```

### 4.2 下钻交互

```
点击 [华东区] 下钻按钮后：

┌─────────────────────────────────────────┐
│  🔍 归因分析                        ✕   │
│  华东区 › 城市分布                       │
├─────────────────────────────────────────┤
│  [← 返回上级]                           │
│                                         │
│  华东区下降-80,000元，以下是城市拆解：    │
│                                         │
├─────────────────────────────────────────┤
│  城市贡献 (4个)                         │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 🏙️ 上海                 -35,000 │   │
│  │ ████████████████████░░░░  43.8% │   │
│  │                          [下钻>] │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 🏙️ 杭州                 -22,000 │   │
│  │ ████████████░░░░░░░░░░░  27.5% │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 🏙️ 南京                 -15,000 │   │
│  │ ████████░░░░░░░░░░░░░░░  18.8% │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 🏙️ 苏州                  -8,000 │   │
│  │ ████░░░░░░░░░░░░░░░░░░░   9.9% │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

---

## 五、技术实现

### 5.1 数据结构

```typescript
// KPI数据结构 - 新增 hideAttribution 字段
interface KPIData {
  id: string;
  label: string;
  value: number | string;
  unit?: string;
  prefix?: string;
  trend?: {
    value: number;
    direction: 'up' | 'down' | 'flat';
    label?: string;
  };
  subMetrics?: SubMetric[];
  isPrimary?: boolean;
  /** 是否隐藏归因按钮 - 用于直接问归因的场景 */
  hideAttribution?: boolean;  // ← 新增字段
}
```

### 5.2 归因按钮显示逻辑

```typescript
// KPICard.tsx 中的归因按钮渲染逻辑
{/* 归因按钮 - 仅对同比/环比显示，且未设置hideAttribution */}
{onAttributionClick && 
 !data.hideAttribution &&  // ← 检查hideAttribution
 (trend.label?.includes('同比') || trend.label?.includes('环比')) && (
  <AttributionTrigger
    trend={trend}
    label={label}
    onAttributionClick={onAttributionClick}
  />
)}
```

### 5.3 归因问题识别

```typescript
// presetResponses.ts 中的归因问题识别
const ATTRIBUTION_QUESTIONS = [
  '为什么销售额下降了',
  '分析销售额增长原因',
  '为什么11月销售额下降了',
  '利润下滑的影响因素有哪些',
  '分析转化率偏低的原因',
  // 关键词
  '为什么',
  '原因',
  '归因',
  '下降了',
  '下滑',
  '增长原因',
  '驱动因素',
  '影响因素',
];

function isAttributionQuestion(question: string): boolean {
  const normalized = question.toLowerCase().trim();
  return ATTRIBUTION_QUESTIONS.some(q => 
    normalized.includes(q.toLowerCase())
  );
}
```

### 5.4 归因场景数据示例

```typescript
// testCaseDataL2More.ts 中的归因场景
'ATTR-01': () => [
  B.heading('🔍 销售额下降原因归因分析'),
  B.kpi({
    id: 'sales_drop',
    label: '本月销售额',
    value: 3200000,
    prefix: '¥',
    trend: { value: 12.5, direction: 'down', label: '环比下降' },
    hideAttribution: true,  // ← 直接问归因，隐藏按钮
  }),
  B.pieChart({
    data: [
      { name: '促销活动减少', value: 35 },
      { name: '华东区异常', value: 28 },
      { name: '线上流量下滑', value: 22 },
      { name: '新品延迟上市', value: 15 },
    ],
    title: '下降原因归因占比',
  }),
  // ...
],
```

---

## 六、测试用例

### 6.1 归因分析专区问题清单

| ID | 问题 | 预期响应 | 归因按钮 |
|----|-----|---------|---------|
| ATTR-01 | 为什么销售额下降了？ | 多维归因饼图+柱状图 | ❌ 隐藏 |
| ATTR-02 | 分析销售额增长原因 | 增长驱动因素分析 | ❌ 隐藏 |
| ATTR-03 | 为什么11月销售额下降了？ | 11月专项归因分析 | ❌ 隐藏 |
| ATTR-04 | 利润下滑的影响因素有哪些？ | 成本因素拆解 | ❌ 隐藏 |
| ATTR-05 | 分析转化率偏低的原因 | 漏斗诊断分析 | ❌ 隐藏 |
| ATTR-06 | 12月份的销售额环比？ | 环比KPI+对比图 | ✅ 显示 |
| ATTR-07 | 今年销售额是多少？ | 年度KPI+趋势图 | ✅ 显示 |
| ATTR-08 | 本月销售额比上月如何？ | 环比分析 | ✅ 显示 |
| ATTR-09 | 华东区销售下降的原因 | 地区维度归因 | ❌ 隐藏 |
| ATTR-10 | 线上渠道增长的驱动因素 | 渠道维度归因 | ❌ 隐藏 |
| ATTR-11 | 产品A销量下滑原因分析 | 产品维度归因 | ❌ 隐藏 |
| ATTR-12 | 详细分析华东区下降原因 | 三层下钻归因 | ❌ 隐藏 |

### 6.2 验证点

- [ ] 直接问归因的问题，KPI卡片上不显示"归因"按钮
- [ ] 查数据的问题，KPI卡片上显示"归因"按钮
- [ ] 点击"归因"按钮，右侧弹出归因分析面板
- [ ] 归因面板支持下钻操作
- [ ] 每个归因问题的答案都不同

---

## 七、用户体验流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                     用户提问                                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   系统识别问题类型             │
              │   isAttributionQuestion()     │
              └───────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │   查数据意图     │             │   归因意图       │
    │   return false  │             │   return true   │
    └─────────────────┘             └─────────────────┘
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │ 走预设响应系统   │             │ 跳过预设响应     │
    │ presetResponses │             │ 走归因场景映射   │
    └─────────────────┘             └─────────────────┘
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │ KPI卡片          │             │ KPI卡片          │
    │ hideAttribution │             │ hideAttribution │
    │ = false (默认)  │             │ = true          │
    └─────────────────┘             └─────────────────┘
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │ 显示 [归因] 按钮 │             │ 不显示归因按钮   │
    └─────────────────┘             └─────────────────┘
              │                               │
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │ 用户可点击按钮   │             │ 主内容区已展示   │
    │ 打开归因面板    │             │ 完整归因分析     │
    └─────────────────┘             └─────────────────┘
```

---

## 八、文件清单

| 文件路径 | 说明 |
|---------|-----|
| `src/types/index.ts` | KPIData 类型定义，新增 hideAttribution |
| `src/components/KPICard.tsx` | KPI卡片组件，检查 hideAttribution |
| `src/services/presetResponses.ts` | 预设响应，识别归因问题 |
| `src/services/narrativeGenerator.ts` | 问题映射到场景 |
| `src/services/testCaseDataL2More.ts` | 归因场景数据定义 |
| `src/components/AttributionPanel.tsx` | 归因面板组件 |
| `src/components/TestScenarioPanel.tsx` | 测试面板，归因专区 |

---

## 九、后续优化方向

1. **智能归因推荐**：根据数据异常程度自动推荐归因分析
2. **归因缓存**：相同维度的归因结果缓存，提升响应速度
3. **归因对比**：支持多时间段归因对比
4. **归因导出**：支持将归因分析结果导出为报告

---

*文档结束*

