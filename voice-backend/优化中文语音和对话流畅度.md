# 优化中文语音和对话流畅度

## 问题描述
用户反馈：
1. 中文发音不自然
2. 对话过程不流畅
3. 不能即时处理语音与文字
4. 不能完整回复

## 解决方案

### 1. 配置 Deepgram TTS 使用中文语音模型

**问题**：Deepgram TTS 默认使用英文语音模型（aura-2-helena-en），导致中文发音不自然。

**解决方案**：配置使用中文语音模型。

**已完成的修改**：
- 在代码中添加了中文语音模型配置
- 默认使用 `aura-2-luna-zh`（中文女性声音）
- 可以通过环境变量 `DEEPGRAM_TTS_VOICE` 自定义

**可用的中文语音模型**（Deepgram 支持）：
- `aura-2-luna-zh` - 中文女性声音（默认）
- `aura-2-stella-zh` - 中文女性声音
- `aura-2-athena-zh` - 中文女性声音
- `aura-2-jasper-zh` - 中文男性声音

**自定义语音模型**：
在 `.env` 文件中添加：
```ini
DEEPGRAM_TTS_VOICE=aura-2-luna-zh
```

### 2. 对话流畅度优化

**已完成的优化**：
- ✅ STT 已配置为中文（zh-CN）
- ✅ 系统提示词已要求中文回复
- ✅ Pipeline 配置正确（用户消息 → LLM → TTS → 输出）

**对话流程**：
1. 用户说话 → STT（语音转文字，中文识别）
2. 转录结果 → LLM（生成中文回复）
3. LLM 回复 → TTS（文字转语音，中文语音模型）
4. 音频输出 → 用户听到回复

### 3. 完整回复保证

**机制**：
- LLMContextAggregator 会聚合完整的 LLM 响应
- TTS 会等待完整文本后才开始合成
- 系统提示词要求完整回复

**如果回复不完整，可能的原因**：
1. LLM 响应被中断（用户说话打断）
2. 网络延迟导致响应不完整
3. TTS 服务问题

## 测试步骤

1. **重启后端服务**：
   ```bash
   cd voice-backend
   python voice_bot.py
   ```

2. **查看日志**：
   - 应该看到：`✅ 使用 Deepgram TTS（与 STT 共用 API Key），语音模型：aura-2-luna-zh`

3. **测试语音对话**：
   - 刷新浏览器页面（F5）
   - 点击语音按钮开始录音
   - 用中文说话（例如："你好，请介绍一下你自己"）
   - 停止录音
   - 检查：
     - 转录是否准确（中文）
     - AI 回复是否完整（中文）
     - 语音是否自然（中文发音）

4. **测试对话流畅度**：
   - 发送多条语音消息
   - 检查响应速度
   - 检查回复是否完整
   - 检查对话是否连贯

## 如果问题仍然存在

### 1. 中文发音不自然

**尝试其他中文语音模型**：
在 `.env` 文件中设置：
```ini
DEEPGRAM_TTS_VOICE=aura-2-stella-zh
```
然后重启服务，测试不同语音模型，选择最适合的。

**检查 Deepgram 文档**：
- 访问 Deepgram 文档查看最新支持的中文语音模型
- 尝试不同的语音模型，选择最自然的

### 2. 对话不流畅

**检查网络**：
- 确保网络连接稳定
- 检查是否有网络延迟

**检查系统资源**：
- 确保后端服务有足够的 CPU 和内存
- 检查是否有其他程序占用资源

**检查日志**：
- 查看后端日志，检查是否有错误
- 检查 STT、LLM、TTS 的处理时间

### 3. 不能即时处理

**检查 VAD 设置**：
- VAD（语音活动检测）已配置
- Turn Analyzer 已配置

**检查前端**：
- 确保前端正确发送音频数据
- 检查 WebSocket 连接是否稳定

### 4. 回复不完整

**检查 LLM 响应**：
- 查看后端日志，检查 LLM 是否返回完整响应
- 检查是否有错误或中断

**检查系统提示词**：
- 确认系统提示词要求完整回复
- 可能需要加强提示词

**检查 TTS 处理**：
- 确认 TTS 收到完整文本
- 检查是否有音频截断

## 进一步优化建议

1. **调整语音模型**：尝试不同的中文语音模型，选择最自然的
2. **优化系统提示词**：确保要求完整、流畅的中文回复
3. **监控性能**：查看日志，找出性能瓶颈
4. **网络优化**：确保网络连接稳定，减少延迟

