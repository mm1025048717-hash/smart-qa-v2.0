# 部署到服务器说明

## 目标服务器
- 地址: `http://47.94.146.148:8888/`
- 端口: `8888`

## 快速部署

### Windows 系统

#### 方式 1: 使用批处理脚本（推荐）
```bash
.\scripts\部署到服务器.bat
```

#### 方式 2: 使用 PowerShell 脚本
```powershell
.\scripts\部署到服务器.ps1
```

### Linux/Mac 系统

```bash
# 1. 安装依赖
npm install

# 2. 构建项目
npm run build

# 3. 启动服务器
PORT=8888 node server.js
```

## 手动部署步骤

### 1. 安装依赖
```bash
npm install
```

### 2. 构建项目
```bash
npm run build
```

### 3. 启动服务器

#### 方式 1: 使用 Node.js server.js
```bash
PORT=8888 node server.js
```

#### 方式 2: 使用 Docker
```bash
cd docker
# 修改 docker-compose.yml 中的端口映射为 8888:80
docker-compose build
docker-compose up -d
```

#### 方式 3: 使用 Nginx
```bash
# 将 dist 目录内容复制到 Nginx 网站根目录
sudo cp -r dist/* /var/www/html/

# 配置 Nginx (示例)
sudo nano /etc/nginx/sites-available/smart-qa
```

Nginx 配置示例：
```nginx
server {
    listen 8888;
    server_name 47.94.146.148;
    
    root /var/www/html;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    location /api/deepseek {
        proxy_pass https://api.deepseek.com;
        proxy_set_header Host api.deepseek.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 部署到远程服务器

### 使用 SCP 上传
```bash
# 1. 打包 dist 目录
tar -czf dist.tar.gz dist/

# 2. 上传到服务器
scp dist.tar.gz root@47.94.146.148:/var/www/smart-qa/

# 3. SSH 登录服务器
ssh root@47.94.146.148

# 4. 解压并启动
cd /var/www/smart-qa
tar -xzf dist.tar.gz
PORT=8888 node server.js
```

### 使用 Git 部署
```bash
# 在服务器上
git clone <your-repo-url>
cd smart-qa
npm install
npm run build
PORT=8888 node server.js
```

## 使用 PM2 管理进程（推荐生产环境）

```bash
# 安装 PM2
npm install -g pm2

# 启动应用
pm2 start server.js --name smart-qa -- --port 8888

# 设置开机自启
pm2 startup
pm2 save

# 查看状态
pm2 status

# 查看日志
pm2 logs smart-qa

# 重启
pm2 restart smart-qa

# 停止
pm2 stop smart-qa
```

## 环境变量配置

### DeepSeek API Key
如果需要修改 API Key，可以设置环境变量：
```bash
export DEEPSEEK_API_KEY=your-api-key
PORT=8888 node server.js
```

或者在 `.env` 文件中配置：
```
DEEPSEEK_API_KEY=your-api-key
PORT=8888
```

## 防火墙配置

### Linux (iptables)
```bash
sudo iptables -A INPUT -p tcp --dport 8888 -j ACCEPT
sudo iptables-save
```

### Linux (ufw)
```bash
sudo ufw allow 8888/tcp
```

### Windows
```powershell
netsh advfirewall firewall add rule name="Smart QA Server" dir=in action=allow protocol=TCP localport=8888
```

## 验证部署

1. 访问 `http://47.94.146.148:8888/`
2. 检查页面是否正常加载
3. 测试 API 功能是否正常

## 常见问题

### 1. 端口被占用
```bash
# Linux/Mac 查看端口占用
lsof -i :8888
# 或
netstat -tulpn | grep 8888

# Windows 查看端口占用
netstat -ano | findstr :8888
```

### 2. 构建失败
- 检查 Node.js 版本（建议 18+）
- 清除缓存：`rm -rf node_modules package-lock.json && npm install`
- 检查磁盘空间

### 3. API 请求失败
- 检查 `server.js` 中的 API Key 配置
- 检查网络连接
- 查看服务器日志

### 4. 静态资源 404
- 检查 `vite.config.ts` 中的 `base` 配置（应为 `/`）
- 检查 Nginx 配置中的 `try_files` 设置

## 更新部署

```bash
# 1. 拉取最新代码
git pull

# 2. 重新构建
npm run build

# 3. 重启服务
pm2 restart smart-qa
# 或
PORT=8888 node server.js
```

## 回滚

```bash
# 使用 Git 回滚到上一个版本
git checkout <previous-commit-hash>
npm run build
pm2 restart smart-qa
```

